<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Fabula and Sjužet in “Wandering Rocks”</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />

    <style>
      p {
        text-indent: 2em;
      }

      p.dialogue {
        text-indent: 0;
      }

      #main_map {
        height: 400px;
        width: 100%;
      }

      .place {
        text-decoration: underline;
      }

      #text_box {
        border: 1px solid #333;
        padding: 10px;
        position: relative;
        overflow-y: scroll;
        height: 200px;
        width: 600px;
        top: 10px;
        background-color: rgba(250, 250, 250, 0.7);
      }

      .navbar {
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Fabula and Sjužet in “Wandering Rocks”</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="list">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Section <span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="#section_1">1.</a></li>
                <li><a href="#section_2">2.</a></li>
                <li><a href="#section_3">3.</a></li>
                <li><a href="#section_4">4.</a></li>
                <li><a href="#section_5">5.</a></li>
                <li><a href="#section_6">6.</a></li>
                <li><a href="#section_7">7.</a></li>
                <li><a href="#section_8">8.</a></li>
                <li><a href="#section_9">9.</a></li>
                <li><a href="#section_10">10.</a></li>
                <li><a href="#section_11">11.</a></li>
                <li><a href="#section_12">12.</a></li>
                <li><a href="#section_13">13.</a></li>
                <li><a href="#section_14">14.</a></li>
                <li><a href="#section_15">15.</a></li>
                <li><a href="#section_16">16.</a></li>
                <li><a href="#section_17">17.</a></li>
                <li><a href="#section_18">18.</a></li>
                <li><a href="#section_19">19.</a></li>
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="btn-group" id="toolbar" role="toolbar" aria-label="play buttons">
              <button disabled="disabled" type="button" class="btn btn-default navbar-btn" id="step_back_btn">
                <span class="glyphicon glyphicon-step-backward"></span>
              </button>
              <button disabled="disabled" type="button" class="btn btn-default navbar-btn" id="play_btn">
                <span class="glyphicon glyphicon-play"></span>
              </button>
              <button disabled="disabled" type="button" class="btn btn-default navbar-btn" id="pause_btn">
                <span class="glyphicon glyphicon-pause"></span>
              </button>
              <button disabled="disabled" type="button" class="btn btn-default navbar-btn" id="step_forward_btn">
                <span class="glyphicon glyphicon-step-forward"></span>
              </button>
            </li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>

    <div class="container-fluid">
      <div id="main_map">
      </div>
      <article id="text_box" data-spy="scroll" data-target="#list"></article>

      <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
      <!-- Latest compiled and minified JavaScript -->
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
      <script src="https://d3js.org/d3.v4.min.js"></script>
      <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
      <script>
        var my = {
          map: L.map('main_map', {zoom: 13, minZoom: 3, maxZoom: 18, center: [53.347778, -6.259722]}),
          geoJSONFile: 'ulysses-1922_instances.geo.json',
          markersLayer: new L.FeatureGroup()
        };

        $.get("./text.html", function(data){
          if(typeof(data) === 'string'){
            $("#text_box").html(data); // how github.io sees it.
          }else{
            $("#text_box").html(data.activeElement.innerHTML); // how my local machine sees it.
          }
        });

        L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
          subdomains: 'abcd',
          maxZoom: 19
        }).addTo(my.map);

        $.getJSON('paths.geojson', function(data){
          console.log("Loading paths");
        }).done(function(data){
          var paths = L.geoJSON(data, {
            onEachFeature: function(feature, layer){
              layer.bindTooltip(L.tooltip({opacity: 0.7}).setContent("Actor: " + feature.properties.actor));
            }
          });
          my.map.addLayer(paths);
        }).fail(function (d, textStatus, error) {
          console.log("getJSON failed, status: " + textStatus + ", error: " + error)
        });

        $.getJSON(my.geoJSONFile, function(data) {
          console.log("Loading " + my.geoJSONFile);
        }).done(function(data) {
          my.geoJSONData = data;
          //$('button', '#toolbar').prop("disabled", false);
          $('#play_btn').prop("disabled", false);
        }).fail(function (d, textStatus, error) {
          console.log("getJSON failed, status: " + textStatus + ", error: " + error)
        });

        $('#play_btn').click(function(){
          var points = my.geoJSONData["features"];
          my.map.removeLayer(my.markersLayer); // so it doesn't duplicate itself
          my.markersLayer = new L.FeatureGroup();
          my.map.addLayer(my.markersLayer);
          var marker;
          for (var i = 0; i < points.length; i++) {
            window.setTimeout(animateMarker(points[i], marker, my.markersLayer), 500);
          }
        });

        function animateMarker(point, marker, markers){
          if (point["geometry"]["coordinates"][0] !== null) {
            if (point["properties"]["space"] === "1") {
              marker = L.marker([point["geometry"]["coordinates"][1], point["geometry"]["coordinates"][0]]).addTo(my.map);
              marker.bindTooltip(point["properties"]["place_name_in_text"]);
              markers.addLayer(marker);
            }
          }
        }

        var parseTime = d3.timeParse("%Y/%m/%d %H'%M'%S");

        d3.csv("instances.csv", function(data) {
          my.instancesRaw = data;
          var instances = [];
          data.forEach(function(obj, i) {
            var instance = {
              latitude: +obj.latitude,
              longitude: +obj.longitude,
              space: +obj.space,
              placeNameInText: obj.place_name_in_text,
              place: obj.place,
              time: parseTime("1904/06/16 " + obj.time),
              placeId: +obj.place_id
            };
            instances.push(instance);
          });
          my.instances = instances;
        });

        d3.csv("collisions.csv", function(data) {
          my.collisionsRaw = data;
          var collisions = [];
          data.forEach(function(obj, i) {
            if(obj.latitude === ""){ 
              // I was lazy about copying over lats and lons. It wouldn't be a
              // terrible idea to use the place id to pull in *all* lats and 
              // lons. That way, instances is always correct, and collisions
              // is only supplemental.
              var place = my.instances.filter(function (instance) {
                return instance.placeId === +obj.place_id;
              })[0];
              obj.latitude = place.latitude;
              obj.longitude = place.longitude;
            }
            var collision = {
              latitude : +obj.latitude,
              longitude : +obj.longitude,
              primaryActor : obj.primary_actor,
              secondaryActor : obj.secondary_actor,
              time: parseTime("1904/06/16 " + obj.time)
            };
            collisions.push(collision);
          });
          my.collisions = collisions;
        });


        
      </script>
    </div> <!-- main container-fluid -->
  </body>
